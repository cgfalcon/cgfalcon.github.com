<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MongoDB Aggregate Framework初探 | Hellofalcon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="MongoDB 2.1 多了新Feature - Aggregation Framework. 最近工作需要就稍微看了下，Mark之
OverviewAggregation提供的功能map-reduce也能做(诸如统计平均值,求和等)。官方那个大胖子说这东西比map-reduce简单, map-reduce 我没用过, 不过从使用Aggregation的情况来看, 进行统计等操作还是蛮方便的。
总">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB Aggregate Framework初探">
<meta property="og:url" content="http://hellofalcon.com/2013/07/06/20130706_MongoDB Aggregate Framework初探/index.html">
<meta property="og:site_name" content="Hellofalcon">
<meta property="og:description" content="MongoDB 2.1 多了新Feature - Aggregation Framework. 最近工作需要就稍微看了下，Mark之
OverviewAggregation提供的功能map-reduce也能做(诸如统计平均值,求和等)。官方那个大胖子说这东西比map-reduce简单, map-reduce 我没用过, 不过从使用Aggregation的情况来看, 进行统计等操作还是蛮方便的。
总">
<meta property="og:image" content="http://hellofalcon.com/img/p_mongodb_aggregate/mongodb.jpg">
<meta property="og:updated_time" content="2015-05-25T05:39:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MongoDB Aggregate Framework初探">
<meta name="twitter:description" content="MongoDB 2.1 多了新Feature - Aggregation Framework. 最近工作需要就稍微看了下，Mark之
OverviewAggregation提供的功能map-reduce也能做(诸如统计平均值,求和等)。官方那个大胖子说这东西比map-reduce简单, map-reduce 我没用过, 不过从使用Aggregation的情况来看, 进行统计等操作还是蛮方便的。
总">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='//fonts.useso.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  
	<script type="text/javascript">
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?67bfad4475dbdde7048d563d6ba2ea54";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo"></i><span class="site-title">Hellofalcon</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/img/avatar.png"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://hellofalcon.com"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/archives">Archives</a></td>
      
        <td><a class="main-nav-link" href="/about">About</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://hellofalcon.com"></form>
      </td>
      </tr>
    </table>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="/img/avatar.png">
      <h2 id="name">Falcon Chu</h2>
      <h3 id="title">Java程序猿@Alibaba</h3>
      <span id="location"><i class="fa fa-map-marker"></i>HangZhou, China</span>
      <a id="follow" href="http://weibo.com/cggogogo">关注我</a>
  	</div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        12
        <span>文章</span>
      </div>
      <div class="article-info-block">
        19
        <span>标签</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a href="https://github.com/cgfalcon" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a href="http://www.zhihu.com/people/cgfalcon" target="_blank" title="zhihu"><i class="fa fa-zhihu"></i></a></td>
        
          <td><a href="http://weibo.com/cggogogo" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
        
        </tr>
      </table>
    </div>
    
  </div>
</aside>
      <section id="main"><article id="post-20130706_MongoDB Aggregate Framework初探" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      MongoDB Aggregate Framework初探
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2013/07/06/20130706_MongoDB Aggregate Framework初探/">
    <time datetime="2013-07-06T01:10:24.000Z" itemprop="datePublished">2013-07-06</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/数据库/">数据库</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/img/p_mongodb_aggregate/mongodb.jpg" alt="MongoDB Aggregate Framework" title="MongoDB Aggregate Framework"></p>
<p><strong>MongoDB 2.1</strong> 多了新Feature - <strong>Aggregation Framework</strong>. 最近工作需要就稍微看了下，Mark之</p>
<h2 id="Overview">Overview</h2><p><strong>Aggregation</strong>提供的功能<strong>map-reduce</strong>也能做(诸如统计平均值,求和等)。官方那个大胖子说这东西比map-reduce简单, map-reduce 我没用过, 不过从使用Aggregation的情况来看, 进行统计等操作还是蛮方便的。</p>
<p>总体而言，Aggregation就是类似Unix-like中的<strong>管道</strong>的概念，可以将很多数据流串起来，不同的数据处理阶段可以再上一个阶段的基础上再次加工。</p>
<a id="more"></a>
<h2 id="Pipeline-Operator">Pipeline-Operator</h2><p>比较常用的有：</p>
<p><strong>$limit</strong> - 限制返回个数，你懂的<br><strong>$group</strong> - 统计操作， 还提供了一系列子命令, $avg, $sum ….<br><strong>$project</strong> -  可以重构数据<br><strong>$skip</strong> - 你懂的<br><strong>$unwind</strong> - 可以将一个包含数组的文档切分成多个, 比如你的文档有 中有个数组字段 A, A中有10个元素, 那么经过 $unwind处理后会产生10个文档，这些文档只有 字段 A不同<br><strong>$sort</strong> - 排序<br><strong>$match</strong> - 可以实现类似query的功能    </p>
<h2 id="Usage_-_Java">Usage - Java</h2><p>我在db中造了些数据(数据时随机生成的, 能用即可)，没有建索引，文档结构如下：</p>
<pre><code><span class="constant">Document结</span>构<span class="symbol">:</span>
  {
   <span class="string">"_id"</span><span class="symbol">:ObjectId</span>(<span class="string">"509944545"</span>),
   <span class="string">"province"</span><span class="symbol">:<span class="string">"海南"</span></span>,
   <span class="string">"age"</span> <span class="symbol">:</span> <span class="number">21</span>,
   <span class="string">"subjects"</span><span class="symbol">:</span>[
{
<span class="string">"name"</span><span class="symbol">:<span class="string">"语文"</span></span>,
<span class="string">"score"</span><span class="symbol">:</span><span class="number">53</span>
},
{
<span class="string">"name"</span><span class="symbol">:<span class="string">"数学"</span></span>,
<span class="string">"score"</span><span class="symbol">:</span><span class="number">27</span>
},
{
<span class="string">"name"</span><span class="symbol">:<span class="string">"英语"</span></span>,
<span class="string">"score"</span><span class="symbol">:</span><span class="number">35</span>
}
 ],
   <span class="string">"name"</span><span class="symbol">:<span class="string">"刘雨"</span></span>
  }
</code></pre><p>接下来要实现两个功能:</p>
<ol>
<li><p>统计上海学生平均年龄        </p>
</li>
<li><p>统计每个省各科平均成绩    </p>
</li>
</ol>
<p>接下来一一道来</p>
<h2 id="统计上海学生平均年龄">统计上海学生平均年龄</h2><p>从这个需求来讲，要实现功能要有几个步骤: 1. 找出上海的学生. 2. 统计平均年龄 (当然也可以先算出所有省份的平均值再找出上海的)。如此思路也就清晰了</p>
<p><strong>首先</strong>用<strong>$match</strong>取出上海学生</p>
<pre><code>{<span class="variable">$match</span>:{<span class="string">'province'</span>:<span class="string">'上海'</span>}}
</code></pre><p><strong>接下来</strong>用<strong>$group</strong>统计平均年龄</p>
<pre><code>{<span class="variable">$group</span>:{_id:’<span class="variable">$province</span>’,<span class="variable">$avg</span>:’<span class="variable">$age</span>’}}
</code></pre><p><strong>$avg</strong> 是 <strong>$group</strong>的子命令，用于求平均值，类似的还有 <strong>$sum</strong>, <strong>$max</strong> ….</p>
<p>上面两个命令等价于</p>
<pre><code><span class="operator"><span class="keyword">select</span> province, <span class="keyword">avg</span>(age) 
<span class="keyword">from</span> student 
<span class="keyword">where</span> province = <span class="string">'上海'</span>
<span class="keyword">group</span> <span class="keyword">by</span> province</span>
</code></pre><p>下面是Java代码</p>
<pre><code>Mongo m = new Mongo<span class="params">(<span class="string">"localhost"</span>, <span class="number">27017</span>)</span>;
DB db = m.getDB<span class="params">(<span class="string">"test"</span>)</span>;
DBCollection coll = db.getCollection<span class="params">(<span class="string">"student"</span>)</span>;

<span class="comment">/*创建 $match, 作用相当于query*/</span>
DBObject match = new BasicDBObject<span class="params">(<span class="string">"$match"</span>, new BasicDBObject<span class="params">(<span class="string">"province"</span>, <span class="string">"上海"</span>)</span>)</span>;

<span class="comment">/* Group操作*/</span>
DBObject groupFields = new BasicDBObject<span class="params">(<span class="string">"_id"</span>, <span class="string">"$province"</span>)</span>;
groupFields.put<span class="params">(<span class="string">"AvgAge"</span>, new BasicDBObject<span class="params">(<span class="string">"$avg"</span>, <span class="string">"$age"</span>)</span>)</span>;
DBObject group = new BasicDBObject<span class="params">(<span class="string">"$group"</span>, groupFields)</span>;

<span class="comment">/* 查看Group结果 */</span>
AggregationOutput output = coll.aggregate<span class="params">(match, group)</span>; <span class="comment">// 执行 aggregation命令</span>
System.out.println<span class="params">(output.getCommandResult<span class="params">()</span>)</span>;
</code></pre><p> 输出结果:</p>
<pre><code>{ "<span class="attribute">serverUsed</span>":<span class="value"><span class="string">"localhost/127.0.0.1:27017"</span> </span>,        
  "<span class="attribute">result</span>":<span class="value">[ 
{"<span class="attribute">_id</span>":<span class="value"><span class="string">"上海"</span></span>, "<span class="attribute">AvgAge</span>":<span class="value"><span class="number">32.09375</span></span>}
]</span>,          
   "<span class="attribute">ok</span>":<span class="value"><span class="number">1.0</span>
 </span>}
</code></pre><p>如此工程就结束了，再看另外一个需求</p>
<h2 id="统计每个省各科平均成绩">统计每个省各科平均成绩</h2><p>首先更具数据库文档结构，subjects是数组形式，需要先<strong>劈</strong>开，然后再进行统计</p>
<p>主要处理步骤如下:</p>
<p><strong>首先</strong>用<strong>$unwind</strong>拆数组.</p>
<pre><code>{<span class="variable">$unwind</span>:’<span class="variable">$subjects</span>’}
</code></pre><p><strong>然后</strong>按照<strong>province</strong>, <strong>subject</strong> 分组并求各科目平均分 </p>
<pre><code>{$<span class="keyword">group</span>:{
 _id:{
     subjname:<span class="string">"$subjects.name"</span>,   <span class="comment">// 指定group字段之一 subjects.name, 并重命名为 subjname</span>
     province:<span class="string">"$province"</span>         <span class="comment">// 指定group字段之一 province, 并重命名为 province(没变)</span>
  },
 AvgScore:{
    $<span class="keyword">avg</span>:<span class="string">"$subjects.score"</span>        <span class="comment">// 对 subjects.score 求平均</span>
 }
 }
</code></pre><p>Java代码如下:<br>    Mongo m = new Mongo(“localhost”, 27017);<br>    DB db = m.getDB(“test”);<br>    DBCollection coll = db.getCollection(“student”);</p>
<pre><code><span class="comment">/* 创建 $unwind 操作, 用于切分数组*/</span>
DBObject unwind = new BasicDBObject<span class="params">(<span class="string">"$unwind"</span>, <span class="string">"$subjects"</span>)</span>;

<span class="comment">/* Group操作*/</span>
DBObject groupFields = new BasicDBObject<span class="params">(<span class="string">"_id"</span>, new BasicDBObject<span class="params">(<span class="string">"subjname"</span>, <span class="string">"$subjects.name"</span>)</span>.append<span class="params">(<span class="string">"province"</span>, <span class="string">"$province"</span>)</span>)</span>;
groupFields.put<span class="params">(<span class="string">"AvgScore"</span>, new BasicDBObject<span class="params">(<span class="string">"$avg"</span>, <span class="string">"$subjects.scores"</span>)</span>)</span>;
DBObject group = new BasicDBObject<span class="params">(<span class="string">"$group"</span>, groupFields)</span>;

<span class="comment">/* 查看Group结果 */</span>
AggregationOutput output = coll.aggregate<span class="params">(unwind, group)</span>;  <span class="comment">// 执行 aggregation命令</span>
System.out.println<span class="params">(output.getCommandResult<span class="params">()</span>)</span>;
  输出结果

{ <span class="string">"serverUsed"</span>:<span class="string">"localhost/127.0.0.1:27017"</span> , 
<span class="string">"result"</span>:[ 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"英语"</span>, <span class="string">"province"</span>:<span class="string">"海南"</span>}, <span class="string">"AvgScore"</span>:<span class="number">58.1</span>} , 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"数学"</span>, <span class="string">"province"</span>:<span class="string">"海南"</span>}, <span class="string">"AvgScore"</span> : <span class="number">60.485</span>} ,
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"语文"</span>, <span class="string">"province"</span>:<span class="string">"江西"</span>}, <span class="string">"AvgScore"</span> : <span class="number">55.538</span>} , 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"英语"</span>, <span class="string">"province"</span>:<span class="string">"上海"</span>}, <span class="string">"AvgScore"</span> : <span class="number">57.65625</span>} , 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"数学"</span>, <span class="string">"province"</span>:<span class="string">"广东"</span>}, <span class="string">"AvgScore"</span> : <span class="number">56.690</span>} , 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"数学"</span>, <span class="string">"province"</span>:<span class="string">"上海"</span>}, <span class="string">"AvgScore"</span> : <span class="number">55.671875</span>} ,
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"语文"</span>, <span class="string">"province"</span>:<span class="string">"上海"</span>}, <span class="string">"AvgScore"</span> : <span class="number">56.734375</span>} , 
  { <span class="string">"_id"</span>:{<span class="string">"subjname"</span>:<span class="string">"英语"</span>, <span class="string">"province"</span>:<span class="string">"云南"</span>}, <span class="string">"AvgScore"</span> : <span class="number">55.7301</span> } ,
  .
  .
  .
  .
 <span class="string">"ok"</span> : <span class="number">1.0</span>
</code></pre><p> }</p>
<p>统计就此结束…. 稍等，似乎有点太粗糙了，虽然统计出来的，但是根本没法看，同一个省份的科目都不在一起. 囧, 接下来进行下加强.</p>
<h4 id="支线任务：_将同一省份的科目成绩统计到一起">支线任务： 将同一省份的科目成绩统计到一起</h4><hr>
<p>在这个步骤中我期望将结果展示位</p>
<pre><code><span class="string">'province'</span>:<span class="string">'xxxxx'</span>, avgscores:[ <span class="comment">{'<span class="doctag"><span class="keyword">xxx</span></span>':<span class="doctag"><span class="keyword">xxx</span></span>}</span>, ....] 这样的形式
</code></pre><p>要做的有一件事，在前面的统计结果的基础上，先用 <strong>$project</strong> 将平均分和成绩揉到一起，即形如下面的样子</p>
<pre><code>{ "<span class="attribute">subjinfo</span>" : <span class="value">{ "<span class="attribute">subjname</span>" : <span class="value"><span class="string">"英语"</span> </span>,"<span class="attribute">AvgScores</span>" : <span class="value"><span class="number">58.1</span> </span>} </span>,"<span class="attribute">province</span>" : <span class="value"><span class="string">"海南"</span> </span>}
</code></pre><p>再按省份group, 将各科目的平均分push到一块, 命令如下:</p>
<p><strong>首先</strong> <strong>$project</strong> 重构group结果</p>
<pre><code>{<span class="variable">$project</span>：{province:<span class="string">"<span class="variable">$_id</span>.province"</span>, subjinfo:{<span class="string">"subjname"</span>:<span class="string">"<span class="variable">$_id</span>.subjname"</span>, <span class="string">"avgscore"</span>:<span class="string">"<span class="variable">$AvgScore</span>"</span>}}
</code></pre><p><strong>再</strong> 使用 <strong>$group</strong> 再次分组</p>
<pre><code>{<span class="variable">$group</span>:{_id:<span class="string">"<span class="variable">$province</span>"</span>, avginfo:{<span class="variable">$push</span>:<span class="string">"<span class="variable">$subjinfo</span>"</span>}}}
</code></pre><p>Java 代码如下：<br>    Mongo m = new Mongo(“localhost”, 27017);<br>    DB db = m.getDB(“test”);<br>    DBCollection coll = db.getCollection(“student”);</p>
<pre><code><span class="comment">/* 创建 $unwind 操作, 用于切分数组*/</span>
DBObject unwind = new BasicDBObject<span class="params">(<span class="string">"$unwind"</span>, <span class="string">"$subjects"</span>)</span>;

<span class="comment">/* Group操作*/</span>
DBObject groupFields = new BasicDBObject<span class="params">(<span class="string">"_id"</span>, new BasicDBObject<span class="params">(<span class="string">"subjname"</span>, <span class="string">"$subjects.name"</span>)</span>.append<span class="params">(<span class="string">"province"</span>, <span class="string">"$province"</span>)</span>)</span>;
groupFields.put<span class="params">(<span class="string">"AvgScore"</span>, new BasicDBObject<span class="params">(<span class="string">"$avg"</span>, <span class="string">"$subjects.scores"</span>)</span>)</span>;
DBObject group = new BasicDBObject<span class="params">(<span class="string">"$group"</span>, groupFields)</span>;

<span class="comment">/* Reshape Group Result*/</span>
DBObject projectFields = new BasicDBObject<span class="params">()</span>;
projectFields.put<span class="params">(<span class="string">"province"</span>, <span class="string">"$_id.province"</span>)</span>;
projectFields.put<span class="params">(<span class="string">"subjinfo"</span>, new BasicDBObject<span class="params">(<span class="string">"subjname"</span>,<span class="string">"$_id.subjname"</span>)</span>.append<span class="params">(<span class="string">"avgscore"</span>, <span class="string">"$AvgScore"</span>)</span>)</span>;
DBObject project = new BasicDBObject<span class="params">(<span class="string">"$project"</span>, projectFields)</span>;

<span class="comment">/* 将结果push到一起*/</span>
DBObject groupAgainFields = new BasicDBObject<span class="params">(<span class="string">"_id"</span>, <span class="string">"$province"</span>)</span>;
groupAgainFields.put<span class="params">(<span class="string">"avginfo"</span>, new BasicDBObject<span class="params">(<span class="string">"$push"</span>, <span class="string">"$subjinfo"</span>)</span>)</span>;
DBObject reshapeGroup = new BasicDBObject<span class="params">(<span class="string">"$group"</span>, groupAgainFields)</span>;

<span class="comment">/* 查看Group结果 */</span>
AggregationOutput output = coll.aggregate<span class="params">(unwind, group, project, reshapeGroup)</span>;
System.out.println<span class="params">(output.getCommandResult<span class="params">()</span>)</span>;
</code></pre><p>结果如下:</p>
<pre><code>{ "<span class="attribute">serverUsed</span>" : <span class="value"><span class="string">"localhost/127.0.0.1:27017"</span> </span>, 
  "<span class="attribute">result</span>" : <span class="value">[ 
   {"<span class="attribute">_id</span>":<span class="value"><span class="string">"辽宁"</span></span>, "<span class="attribute">avginfo</span>":<span class="value">[{"<span class="attribute">subjname</span>":<span class="value"><span class="string">"数学"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">56.46666666666667</span></span>}, {"<span class="attribute">subjname</span>":<span class="value"><span class="string">"英语"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">52.093333333333334</span></span>}, {"<span class="attribute">subjname</span>":<span class="value"><span class="string">"语文"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">50.53333333333333</span></span>}]</span>} , 
   {"<span class="attribute">_id</span>":<span class="value"><span class="string">"四川"</span></span>, "<span class="attribute">avginfo</span>":<span class="value">[{"<span class="attribute">subjname</span>":<span class="value"><span class="string">"数学"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">52.72727272727273</span></span>}, {"<span class="attribute">subjname</span>":<span class="value"><span class="string">"英语"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">55.90909090909091</span></span>}, {"<span class="attribute">subjname</span>":<span class="value"><span class="string">"语文"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">57.59090909090909</span></span>}]</span>} , 
   {"<span class="attribute">_id</span>":<span class="value"><span class="string">"重庆"</span></span>, "<span class="attribute">avginfo</span>":<span class="value">[{ "<span class="attribute">subjname</span>":<span class="value"><span class="string">"语文"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">56.077922077922075</span></span>}, { "<span class="attribute">subjname</span>":<span class="value"><span class="string">"英语"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">54.84415584415584</span></span>}, { "<span class="attribute">subjname</span>":<span class="value"><span class="string">"数学"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">55.33766233766234</span></span>}]</span>} , 
   {"<span class="attribute">_id</span>":<span class="value"><span class="string">"安徽"</span></span>, "<span class="attribute">avginfo</span>":<span class="value">[{ "<span class="attribute">subjname</span>":<span class="value"><span class="string">"英语"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">55.458333333333336</span></span>}, { "<span class="attribute">subjname</span>":<span class="value"><span class="string">"数学"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">54.47222222222222</span></span>}, { "<span class="attribute">subjname</span>":<span class="value"><span class="string">"语文"</span></span>, "<span class="attribute">avgscore</span>":<span class="value"><span class="number">52.80555555555556</span></span>}]</span>} 
    .
    .
    .
   ] </span>, "<span class="attribute">ok</span>" : <span class="value"><span class="number">1.0</span></span>}
</code></pre><p>至此，功能也就完成了，呼</p>
<h3 id="结语">结语</h3><hr>
<p>Aggravation 这就介绍完了, 当然还有很多细节没说清楚，更多的资料可以参考<a href="http://docs.mongodb.org/manual/applications/aggregation/" target="_blank" rel="external">MongoDB官方文档</a>. 期待后期再深入挖掘其功能.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hellofalcon.com/2013/07/06/20130706_MongoDB Aggregate Framework初探/" data-id="cicit1nx0001q9ohh2bb0kikx" class="article-share-link">分享到</a>
      
        <a href="http://hellofalcon.com/2013/07/06/20130706_MongoDB Aggregate Framework初探/#ds-thread" class="article-comment-link">评论</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/11/03/20131103_java_annotation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java注解
        
      </div>
    </a>
  
  
    <a href="/2013/05/18/20130518_读《重构-改善既有代码的设计》的感悟/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">读《重构-改善既有代码的设计》的感悟</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="http://hellofalcon.com/2013/07/06/20130706_MongoDB Aggregate Framework初探/" data-title="MongoDB Aggregate Framework初探" data-url="http://hellofalcon.com/2013/07/06/20130706_MongoDB Aggregate Framework初探/">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by DuoShuo.</a></noscript>
      </div>
  </section>
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul id="recent-post" class="">
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2015/07/25/20150725_JavaScript学习笔记/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/编程/">编程</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/编程/读书笔记/">读书笔记</a></p>
              <p class="item-title"><a href="/2015/07/25/20150725_JavaScript学习笔记/" class="title">JavaScript 学习笔记</a></p>
              <p class="item-date"><time datetime="2015-07-25T08:37:49.000Z" itemprop="datePublished">2015-07-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2015/07/25/20150718_数据可视化/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/编程/">编程</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/编程/读书笔记/">读书笔记</a></p>
              <p class="item-title"><a href="/2015/07/25/20150718_数据可视化/" class="title">D3.js 数据可视化</a></p>
              <p class="item-date"><time datetime="2015-07-25T00:34:49.000Z" itemprop="datePublished">2015-07-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2015/06/10/20150610-programers-architect/" class="thumbnail">
  
    <span style="background-image:url(http://img4.douban.com/lpic/s27766899.jpg
)" alt="读《程序员必读之软件架构》" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/编程/">编程</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/编程/读书笔记/">读书笔记</a></p>
              <p class="item-title"><a href="/2015/06/10/20150610-programers-architect/" class="title">读《程序员必读之软件架构》</a></p>
              <p class="item-date"><time datetime="2015-06-10T00:34:49.000Z" itemprop="datePublished">2015-06-10</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2015/05/29/20150529_javascript-start/" class="thumbnail">
  
    <span style="background-image:url(http://img4.douban.com/lpic/s1888787.jpg
)" alt="Javascript 学习书单" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/编程/">编程</a></p>
              <p class="item-title"><a href="/2015/05/29/20150529_javascript-start/" class="title">Javascript 学习书单</a></p>
              <p class="item-date"><time datetime="2015-05-29T01:09:51.000Z" itemprop="datePublished">2015-05-29</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2014/06/22/20140622_scala-startups/" class="thumbnail">
  
    <span style="background-image:url(/img/scalahierarchy.png
)" alt="scala-startups" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/编程/">编程</a></p>
              <p class="item-title"><a href="/2014/06/22/20140622_scala-startups/" class="title">scala-startups</a></p>
              <p class="item-date"><time datetime="2014-06-22T01:10:24.000Z" itemprop="datePublished">2014-06-22</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程/读书笔记/">读书笔记</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/职业生涯/">职业生涯</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/职业生涯/年度回顾/">年度回顾</a><span class="category-list-count">1</span></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2013总结/">2013总结</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/D3-js/">D3.js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECMAScript/">ECMAScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Junit/">Junit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/annotation/">annotation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数式编程/">函数式编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据可视化/">数据可视化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程语言/">编程语言</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/重构/">重构</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/2013总结/" style="font-size: 10px;">2013总结</a> <a href="/tags/D3-js/" style="font-size: 10px;">D3.js</a> <a href="/tags/ECMAScript/" style="font-size: 10px;">ECMAScript</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/Junit/" style="font-size: 10px;">Junit</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Scala/" style="font-size: 10px;">Scala</a> <a href="/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/函数式编程/" style="font-size: 10px;">函数式编程</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/数据可视化/" style="font-size: 10px;">数据可视化</a> <a href="/tags/架构/" style="font-size: 10px;">架构</a> <a href="/tags/编程语言/" style="font-size: 10px;">编程语言</a> <a href="/tags/读书笔记/" style="font-size: 10px;">读书笔记</a> <a href="/tags/重构/" style="font-size: 10px;">重构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Falcon Chu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"hellofalcon"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>